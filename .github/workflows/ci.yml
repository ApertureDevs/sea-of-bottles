name: Continuous Integration checks

on: push

jobs:
  global-ci:
    name: Global CI
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Add Task Runner
        run: |
          curl -sL https://taskfile.dev/install.sh | sh && echo "./bin" >> $GITHUB_PATH
      - name: Global YAML Linter
        run: |
          task global-yaml-linter-check --summary
          task global-yaml-linter-check
      - name: Global Markdown Linter
        run: |
          task global-markdown-linter-check --summary
          task global-markdown-linter-check
      - name: Commit Linter
        run: |
          task global-commit-linter-check --summary
          task global-commit-linter-check

  frontend-ci:
    name: Frontend CI
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Add Task Runner
        run: |
          curl -sL https://taskfile.dev/install.sh | sh && echo "./bin" >> $GITHUB_PATH
      - name: Frontend Install
        run: |
          task install --summary
          cp .github/assets/docker-compose.override.yaml docker-compose.override.yaml
          mkdir frontend/node_modules
          chmod -R 777 frontend/node_modules
          mkdir frontend/var
          chmod -R 777 frontend/var
          mkdir frontend/dist
          chmod -R 777 frontend/dist
          task install
      - name: Frontend NPM Vulnerability Check
        run: |
          task frontend-npm-security-check --summary
          task frontend-npm-security-check
      - name: Frontend Typescript Linter
        run: |
          task frontend-ts-linter-check --summary
          task frontend-ts-linter-check
      - name: Frontend SASS Linter
        run: |
          task frontend-sass-linter-check --summary
          task frontend-sass-linter-check
      - name: Frontend HTML Linter
        run: |
          task frontend-html-linter-check --summary
          task frontend-html-linter-check
      - name: Frontend Unit Tests
        run: |
          task frontend-unit --summary
          task frontend-unit
      - name: Frontend E2E tests
        run: |
          task frontend-e2e --summary
          task frontend-e2e
      - name: Frontend Build Prod
        run: |
          task frontend-build --summary
          BUILD_ENV=prod task frontend-build
      - name: Frontend Build Preprod
        run: |
          task frontend-build --summary
          BUILD_ENV=preprod task frontend-build
      - name: Frontend Build Dev
        run: |
          task frontend-build --summary
          BUILD_ENV=dev task frontend-build

  api-ci:
    name: API CI
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Add Task Runner
        run: |
          curl -sL https://taskfile.dev/install.sh | sh && echo "./bin" >> $GITHUB_PATH
      - name: API Composer Vulnerability Check
        run: |
          task api-composer-security-check --summary
          task api-composer-security-check
      - name: API Test Database
        run: |
          task api-database-create-test --summary
          task api-database-create-test
          task api-database-migration-test --summary
          task api-database-migration-test
          task api-database-fixture-test --summary
          task api-database-fixture-test
          task api-database-schema-check --summary
          task api-database-schema-check
      - name: API PHP Linter
        run: |
          task api-php-linter-check --summary
          task api-php-linter-check
      - name: API PHPStan Analysis
        run: |
          task api-phpstan-check --summary
          task api-phpstan-check
      - name: API PHP Dependencies Check
        run: |
          task api-composer-check --summary
          task api-composer-check
      - name: API PHP Layers Dependencies Analysis
        run: |
          task api-layers-check --summary
          task api-layers-check
      - name: API Unit Tests
        run: |
          task api-phpunit --summary
          task api-phpunit
      - name: API E2E Tests
        run: |
          task api-behat --summary
          task api-behat
      - name: API Build Prod
        run: |
          task api-build --summary
          BUILD_ENV=prod task api-build
      - name: API Build Dev
        run: |
          task api-build --summary
          BUILD_ENV=dev task api-build
